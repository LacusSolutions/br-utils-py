#!/usr/bin/env python3

"""
Monorepo management scripts.

Usage:
    python run install-dev       # Install development dependencies
    python run test              # Run tests for current package
    python run test-all          # Run tests for all packages
    python run build [pkg]       # Build specified package or all
    python run publish [pkg]     # Publish specified package or all
    python run clean             # Remove build files
    python run hooks install     # Install Git hooks
    python run hooks uninstall   # Uninstall Git hooks
    python run hooks list        # List configured Git hooks
"""

import argparse
import sys
from pathlib import Path
from scripts import build
from scripts import clean
from scripts import common
from scripts import hooks
from scripts import install_dev
from scripts import publish
from scripts import test


PACKAGES = common.PACKAGES
PACKAGES_DIR = common.PACKAGES_DIR


def main():
    parser = argparse.ArgumentParser(
        description="Monorepo management scripts",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
python run install-dev
python run test-all
python run build cnpj-fmt
python run build-all
python run publish cnpj-fmt
python run publish-all
python run clean
python run hooks install
python run hooks list
      """,
    )

    subparsers = parser.add_subparsers(dest="command", help="Command to execute")

    subparsers.add_parser("install-dev", help="Install development dependencies")

    test_parser = subparsers.add_parser("test", help="Run tests")
    test_parser.add_argument("package", nargs="?", help="Specific package (optional)")

    subparsers.add_parser("test-all", help="Run tests for all packages")

    build_parser = subparsers.add_parser("build", help="Build package(s)")
    build_parser.add_argument(
        "package", nargs="?", help="Specific package (leave empty for all)"
    )

    subparsers.add_parser("build-all", help="Build all packages")

    publish_parser = subparsers.add_parser("publish", help="Publish package(s) to PyPI")
    publish_parser.add_argument(
        "package", nargs="?", help="Specific package (leave empty for all)"
    )

    subparsers.add_parser("publish-all", help="Publish all packages to PyPI")

    subparsers.add_parser("clean", help="Remove build files")

    hooks_parser = subparsers.add_parser("hooks", help="Manage Git hooks")
    hooks_subparsers = hooks_parser.add_subparsers(dest="hooks_command", help="Hooks command")
    hooks_subparsers.add_parser("install", help="Install Git hooks")
    hooks_subparsers.add_parser("uninstall", help="Uninstall Git hooks")
    hooks_subparsers.add_parser("list", help="List configured Git hooks")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    if args.command == "install-dev":
        install_dev.install_dev()

    elif args.command == "test":
        if args.package:
            if args.package not in PACKAGES:
                print(f"Error: Package '{args.package}' not found.")
                print(f"Available packages: {', '.join(PACKAGES)}")
                sys.exit(1)
            pkg_path = PACKAGES_DIR / args.package

            if not test.test_package(pkg_path):
                sys.exit(1)
        else:
            cwd = Path.cwd()

            if PACKAGES_DIR in cwd.parents:
                pkg_name = None
                current = cwd

                while current != PACKAGES_DIR.parent:
                    if current.parent == PACKAGES_DIR:
                        pkg_name = current.name
                        break
                    current = current.parent

                if pkg_name and pkg_name in PACKAGES:
                    test.test_package(PACKAGES_DIR / pkg_name)
                else:
                    print(
                        "Error: Current directory is not a valid package. Specify the package or use 'test-all'"
                    )
                    sys.exit(1)
            else:
                print(
                    "Error: Not inside a package. Specify the package or use 'test-all'"
                )
                sys.exit(1)

    elif args.command == "test-all":
        test.test_all()

    elif args.command == "build":
        if args.package:
            if args.package not in PACKAGES:
                print(f"Error: Package '{args.package}' not found.")
                print(f"Available packages: {', '.join(PACKAGES)}")
                sys.exit(1)
            pkg_path = PACKAGES_DIR / args.package

            if not build.build_package(pkg_path):
                sys.exit(1)
        else:
            build.build_all()

    elif args.command == "build-all":
        build.build_all()

    elif args.command == "publish":
        if args.package:
            if args.package not in PACKAGES:
                print(f"Error: Package '{args.package}' not found.")
                print(f"Available packages: {', '.join(PACKAGES)}")
                sys.exit(1)
            pkg_path = PACKAGES_DIR / args.package

            if not publish.publish_package(pkg_path):
                sys.exit(1)
        else:
            cwd = Path.cwd()

            if PACKAGES_DIR in cwd.parents:
                pkg_name = None
                current = cwd

                while current != PACKAGES_DIR.parent:
                    if current.parent == PACKAGES_DIR:
                        pkg_name = current.name
                        break
                    current = current.parent

                if pkg_name and pkg_name in PACKAGES:
                    if not publish.publish_package(PACKAGES_DIR / pkg_name):
                        sys.exit(1)
                else:
                    print(f"Error: Current directory is not a valid package.")
                    sys.exit(1)
            else:
                print(
                    "Error: Not inside a package. Specify the package or use 'publish-all'"
                )
                sys.exit(1)

    elif args.command == "publish-all":
        publish.publish_all()

    elif args.command == "clean":
        clean.clean()

    elif args.command == "hooks":
        if not args.hooks_command:
            hooks_parser.print_help()
            sys.exit(1)

        if args.hooks_command == "install":
            if not hooks.install_hooks():
                sys.exit(1)
        elif args.hooks_command == "uninstall":
            if not hooks.uninstall_hooks():
                sys.exit(1)
        elif args.hooks_command == "list":
            hooks.list_hooks()
        else:
            hooks_parser.print_help()
            sys.exit(1)

    else:
        parser.print_help()
        sys.exit(1)


if __name__ == "__main__":
    main()
