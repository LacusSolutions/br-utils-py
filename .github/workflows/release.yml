name: Create Release and Publish

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name to release'
        required: true
        type: string
      version:
        description: 'Version to release (e.g., 1.2.3 or 1.2.3-alpha1)'
        required: true
        type: string

env:
  TWINE_USERNAME: __token__
  TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.validate.outputs.branch_name }}
      commit_sha: ${{ steps.validate.outputs.commit_sha }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
      package: ${{ steps.validate.outputs.package }}
      version: ${{ steps.validate.outputs.version }}
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - id: validate
        run: |
          PKG_NAME="${{ inputs.package }}"
          PKG_VERSION="${{ inputs.version }}"

          echo "ðŸ” Validating package and version..."
          echo "Package: $PKG_NAME"
          echo "Version: $PKG_VERSION"

          if [ ! -d "packages/$PKG_NAME" ]; then
            echo "âŒ Package '$PKG_NAME' does not exist in packages/ directory"
            exit 1
          fi

          if [ ! -f "packages/$PKG_NAME/pyproject.toml" ]; then
            echo "âŒ Package '$PKG_NAME' does not have a 'pyproject.toml' file"
            exit 1
          fi

          echo "âœ… Package '$PKG_NAME' exists"
          echo "âœ… Package '$PKG_NAME' has a 'pyproject.toml' file"

          # Accepted versions format:
          # - stable: \d+\.\d+\.\d+
          # - pre-release: \d+\.\d+\.\d+-(dev|alpha|beta|rc)\d+
          if [[ ! "$PKG_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(dev|alpha|beta|rc)[0-9]+)?$ ]]; then
            echo "âŒ Version '$PKG_VERSION' does not match expected format:"
            echo "   Expected: X.Y.Z or X.Y.Z-{dev,alpha,beta,rc}N"
            echo "   Example: 1.2.3 or 1.2.3-alpha1"
            exit 1
          fi

          echo "âœ… Version format is valid"

          TAG_NAME="${PKG_NAME}@${PKG_VERSION}"
          echo "ðŸ” Checking if tag '$TAG_NAME' already exists..."

          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âŒ Tag '$TAG_NAME' already exists"
            exit 1
          fi

          RELEASE_CHECK=$(curl -s \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG_NAME}" \
            -X GET \
            -H "Authorization: token $GITHUB_TOKEN")

          if echo "$RELEASE_CHECK" | jq -e '.id' >/dev/null 2>&1; then
            echo "âŒ Release '$TAG_NAME' already exists"
            exit 1
          fi

          echo "âœ… Tag '$TAG_NAME' is available"
          echo "âœ… Release '$TAG_NAME' does not exist"

          BRANCH_NAME="${PKG_NAME}/main"
          echo "ðŸ” Checking if branch '$BRANCH_NAME' exists..."

          git fetch origin --quiet 2>/dev/null || true

          if ! git show-ref --verify --quiet "refs/heads/$BRANCH_NAME" && \
             ! git show-ref --verify --quiet "refs/remotes/origin/$BRANCH_NAME"; then
            echo "âŒ Branch '$BRANCH_NAME' does not exist"
            echo "   Available branches:"
            git branch -a | grep -E "(main|$PKG_NAME)" || echo "   (none found)"
            exit 1
          fi

          echo "âœ… Branch '$BRANCH_NAME' exists"

          if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
            COMMIT_SHA=$(git rev-parse "$BRANCH_NAME")
          else
            COMMIT_SHA=$(git rev-parse "origin/$BRANCH_NAME")
          fi

          echo "ðŸ“ Branch '$BRANCH_NAME' points to commit: $COMMIT_SHA"

          echo "package=$PKG_NAME" >> $GITHUB_OUTPUT
          echo "version=$PKG_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

  create-release:
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ needs.validate.outputs.tag_name }}
      package: ${{ needs.validate.outputs.package }}
      version: ${{ needs.validate.outputs.version }}
      release_id: ${{ steps.create-release.outputs.release_id }}
    steps:
      - id: create-release
        run: |
          BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
          COMMIT_SHA="${{ needs.validate.outputs.commit_sha }}"
          TAG_NAME="${{ needs.validate.outputs.tag_name }}"
          PKG_NAME="${{ needs.validate.outputs.package }}"
          PKG_VERSION="${{ needs.validate.outputs.version }}"

          echo "ðŸš€ Creating release '$TAG_NAME' on branch '$BRANCH_NAME'..."

          # Create release via GitHub API
          RELEASE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases" \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{
              \"target_commitish\": \"$COMMIT_SHA\",
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"$PKG_NAME $PKG_VERSION\",
              \"draft\": false,
              \"prerelease\": $([[ "$PKG_VERSION" =~ -(dev|alpha|beta|rc) ]] && echo "true" || echo "false")
            }")

          HTTP_CODE=$(echo "$RELEASE_RESPONSE" | tail -n1)
          RELEASE_BODY=$(echo "$RELEASE_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "âŒ Failed to create release. HTTP status: $HTTP_CODE"
            echo "Response: $RELEASE_BODY"
            exit 1
          fi

          RELEASE_ID=$(echo "$RELEASE_BODY" | jq -r '.id')

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "âŒ Failed to get release ID from response"
            echo "Response: $RELEASE_BODY"
            exit 1
          fi

          echo "âœ… Release created successfully (ID: $RELEASE_ID)"
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT

  publish:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: main
          fetch-depth: 0
      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.x'

      - run: python -m pip install --upgrade pip
      - run: python require

      - name: Build and Publish Package
        run: |
          PKG_NAME="${{ needs.create-release.outputs.package }}"
          PKG_VERSION="${{ needs.create-release.outputs.version }}"

          echo "ðŸ“¦ Building package '$PKG_NAME' version '$PKG_VERSION'..."
          python run build "$PKG_NAME" -v "$PKG_VERSION"

          echo "ðŸš€ Publishing package '$PKG_NAME' to PyPI..."
          python run publish "$PKG_NAME"
